# Java并发编程

## 进程与线程

### 2.1 进程与线程的概念

**进程**

* 程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至CPU，数据加载至内存。在指令运行的过程中还需要用到磁盘，网络等设备。进程就是用来加载指令、管理内存、管理IO的。
* 当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。
* 进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程，也有的程序只能启动一个实例进程

**线程**

* 一个进程之内可以分为一到多个线程。
* 一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给CPU执行
* Java中，线程作为最小调度单位，进程作为资源分配的最小单位。

**两者对比**

* 进程是相互独立的，而线程存在于进程内，是进程的一个子集

* 进程拥有共享的资源，如内存空间等，供其内部的线程共享

* 进程间通信较为复杂

  同一台计算机的进程通信称为 IPC (Inter-process communication)

  不同计算机之间的进程通信，需要通过网络，并遵守共同的协议，如HTTP

* 线程通信相对简单，因为他们共享进程的内存，例如：多个线程可以访问一个共享变量

* 线程更轻量，线程上下文切换成本一般要比进程上下文切换低

### 2.2 并行与并发

单核CPU下，线程实际是串行执行的。操作系统中有一个组件叫做任务调度器，将CPU的时间片分给不同的线程使用，只是由于CPU在线程间切换的非常快，人类感觉是同时运行的。总结为：**微观串行，宏观并行**

一般将这种**线程轮流使用CPU**的做法称为**并发**

**多核CPU**下，每个核都可以调度运行线程，这个时候线程是**并行**的

### 2.3 应用

**同步与异步**

* 需要等待结果返回才能继续运行就是同步
* 不需要等待结果返回就能继续运行的就是异步

注意：同步在多线程中还有另外一层意思，就是多个线程步调一致

**设计**

多线程可以让方法执行变为异步的，例如磁盘读取文件是，假设读取文件耗费5秒，如果没有线程调度机制这些时间调用者无法继续进行下面的操作。

**案例**

* tomcat的异步servlet，让用户线程处理耗时较长的操作，避免阻塞tomcat的工作线程
* UI程序中，开线程进行其他操作，避免阻塞UI线程



## 测试环境搭建

* 基准测试工具选择，使用JMH，它会进行程序预热，执行多次测试并平均

* 测试代码如下

  ```shell
  # 在一个空目录生成一个测试项目
  mvn archetype:generate -DinteractiveMode=false -DarchetypeGroupId=org.openjdk.jmh -DarchetypeArtifactId=jmh-java-benchmark-archetype -DgroupId=com.jenkov -DartifactId=first-benchmark -Dversion=1.0
  ```
## 创建和运行线程

### 常见的创建线程的方式

1. 继承Thread重写run方法
2. 实现runnable接口
3. futuretask方法

### 查看线程的方式

**Windows**

* 任务管理器可以查看进程和线程也可以杀死进程
* tasklist查看进程
* taskkill杀死进程

**Linux**

* ps -fe查看所有进程
* ps -fT -p <PID> 查看某个进程PID的所有线程
* kill 杀死进程
* top 按大写H切换是否显示线程
* top -H -p  <PID> 查看某个进程的所有线程

**Java**

* jsp命令查看所有java进程
* jstack <PID> 查看某个java进程的所有线程状态
* jconsole 来查看某个java进程中线程的运行情况（图形界面）

## 线程运行原理

### 3.1 栈与栈帧

Java Virtual Machine Stacks（Java 虚拟机栈）

我们都知道JVM中由堆、栈、方法区所组成，其中栈内存是给谁用的呢？其实就是线程，每个线程启动 
后，虚拟机就会为其分配一块栈内存。

* 每个栈由多个栈帧（Frame)组成，对应着每次方法调用时所占用的内存 
* 每个线程只能有一个活动栈帧，对应着当前正在执行的那个方法

### 3.2 线程上下文切换

因为以下一些原因导致cpu不再执行当前的线程，转而执行另一个线程的代码

* 线程的cpu时间片用完 
* 垃圾回收
* 有更离优先级的线程需要运行
*  线程自己调用了 sleep、yield、wait、join、park、synchronized、 lock 等方法程序

当Context Switch发生时，需要由操作系统保存当前线程的状态，并恢复另一个线程的状态，Java中对应的概念就是程序计数器（ Program Counter Register) , 它 的 作 用 是 记 住 下 一 条 jvm指令的执行地址#是线程私有的